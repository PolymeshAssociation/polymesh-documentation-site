"use strict";(self.webpackChunkpolymesh_developer_documentation=self.webpackChunkpolymesh_developer_documentation||[]).push([[90467],{72532:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"polymesh-private/confidential-assets/settlement","title":"Settlement","description":"","source":"@site/polymesh-docs/polymesh-private/confidential-assets/settlement.md","sourceDirName":"polymesh-private/confidential-assets","slug":"/polymesh-private/confidential-assets/settlement","permalink":"/polymesh-documentation-site/polymesh-docs/polymesh-private/confidential-assets/settlement","draft":false,"unlisted":false,"editUrl":"https://github.com/PolymeshAssociation/polymesh-documentation-site/edit/develop/polymesh-docs/polymesh-private/confidential-assets/settlement.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Settlement","description":"","subsite":"polymesh-private-docs"},"sidebar":"defaultSidebar","previous":{"title":"Confidential Assets","permalink":"/polymesh-documentation-site/polymesh-docs/polymesh-private/confidential-assets/"},"next":{"title":"Sequence Diagrams","permalink":"/polymesh-documentation-site/polymesh-docs/polymesh-private/confidential-assets/diagrams"}}');var s=n(74848),r=n(28453);const a={sidebar_position:2,title:"Settlement",description:"",subsite:"polymesh-private-docs"},o=void 0,c={},l=[{value:"Overview",id:"overview",level:2},{value:"Settlement Venues",id:"settlement-venues",level:2},{value:"Roles",id:"roles",level:2},{value:"Asset Issuer",id:"asset-issuer",level:3},{value:"Venue Owner",id:"venue-owner",level:3},{value:"Sender",id:"sender",level:3},{value:"Receiver",id:"receiver",level:3},{value:"Auditor",id:"auditor",level:3},{value:"Mediator",id:"mediator",level:3},{value:"Affirmation",id:"affirmation",level:2},{value:"Rejection",id:"rejection",level:2},{value:"Instruction Execution",id:"instruction-execution",level:2},{value:"Frozen Assets and Confidential Account",id:"frozen-assets-and-confidential-account",level:2},{value:"Settlement Flowchart",id:"settlement-flowchart",level:2}];function d(e){const t={a:"a",admonition:"admonition",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(t.p,{children:["Confidential Assets are transferred via Settlement Instructions, which consist of one or more asset transfer legs. Each leg represents a transfer of one or more assets between a sender and receivers' ",(0,s.jsx)(t.a,{href:"/polymesh-documentation-site/polymesh-docs/polymesh-private/confidential-assets/#confidential-accounts",children:"confidential accounts"}),". Once all parties affirm all legs, the instruction can be executed atomically, meaning all legs simultaneously succeed or fail. Settlement Instructions can represent single asset transfers (e.g., ACME), bilateral exchange of assets (e.g., USDC vs. ACME), or netted end-of-period settlements."]}),"\n",(0,s.jsx)(t.p,{children:"To ensure the validity of asset transactions, each user sending assets must provide a zero-knowledge proof, verified on-chain using a sigma protocol."}),"\n",(0,s.jsx)(t.p,{children:"The proof establishes:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"The user has sufficient funds (a positive balance after the transfer)."}),"\n",(0,s.jsx)(t.li,{children:"The user is transferring a positive amount."}),"\n",(0,s.jsx)(t.li,{children:"A corresponding value is being added to the receiver's balance."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"To demonstrate sufficient balance, a user sending assets must provide a proof referencing their current (encrypted) balance. This proof would be invalidated if a user's balance decreased (via another executed settlement instruction) before the associated settlement instruction executed."}),"\n",(0,s.jsx)(t.p,{children:"To prevent this, we use the following scheme:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"All incoming transfer increases are kept in a pending balance, not immediately applied to a user's current balance."}),"\n",(0,s.jsx)(t.li,{children:"All outgoing transfer decreases are immediately debited from a user's current balance when they affirm as a sender."}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsx)(t.p,{children:"In case an instruction is rejected after a sender's encrypted balance has decreased, the returned balance is made available to them through their incoming balance."})}),"\n",(0,s.jsx)(t.p,{children:"This allows users to:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Participate in concurrent settlement instructions as interleaved senders and receivers."}),"\n",(0,s.jsx)(t.li,{children:"Control when their current balance is updated, and hence any outstanding sender proofs not yet submitted to the chain invalidated."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Additionally, the user sending the assets must supply copies of the transaction amounts, encrypted against any required auditors' public keys. They provide a zero-knowledge proof that these encrypted values match those actually being transacted."}),"\n",(0,s.jsx)(t.h2,{id:"settlement-venues",children:"Settlement Venues"}),"\n",(0,s.jsx)(t.p,{children:"Settlement Venues are integral to managing transactions involving Confidential Assets. Each settlement instruction must be linked to a Settlement Venue, which provides a framework to control who can initiate transactions with a Confidential Asset."}),"\n",(0,s.jsxs)(t.p,{children:["When a Settlement Venue is created, it's tied to the creator's DID (Decentralized Identifier). This connection ensures that only the venue owner has the authority to add settlement instructions. In the case of Confidential Assets, venue owners can specify additional parameters such as ",(0,s.jsx)(t.a,{href:"#auditor",children:"Auditors"})," and mandatory ",(0,s.jsx)(t.a,{href:"#mediator",children:"Mediators"}),", supplementing those initially defined by the asset creator."]}),"\n",(0,s.jsx)(t.p,{children:"Asset Issuers can optionally restrict transfers of their Confidential Asset(s) to specific venues only, providing a practical framework for efficiently maintaining control over Confidential Asset transactions."}),"\n",(0,s.jsx)(t.h2,{id:"roles",children:"Roles"}),"\n",(0,s.jsx)(t.p,{children:"Settlement instructions involve multiple parties performing various roles. The number of participants involved in an instruction can range from 2 to many, as some roles are optional or may be shared by the same entity. Each role is described in the following sections."}),"\n",(0,s.jsx)(t.h3,{id:"asset-issuer",children:"Asset Issuer"}),"\n",(0,s.jsx)(t.p,{children:"While the Asset Issuer may not be directly involved in a settlement instruction, they play a crucial role. The Asset Issuer controls Auditors and mandatory Mediators for all settlement instructions, regardless of the settlement venue. They also have the authority to allow or block specific settlement venues and freeze asset transfers for all users or specific confidential accounts."}),"\n",(0,s.jsx)(t.h3,{id:"venue-owner",children:"Venue Owner"}),"\n",(0,s.jsx)(t.p,{children:"The Venue Owner is responsible for creating the settlement instruction. They specify the sender and receiver confidential accounts for each leg and the confidential asset(s) for each instruction leg. Additionally, they may opt to include additional Auditors and Mediators when creating a settlement instruction."}),"\n",(0,s.jsx)(t.h3,{id:"sender",children:"Sender"}),"\n",(0,s.jsxs)(t.p,{children:["For each settlement leg, a Sender must be defined. This is the confidential account that will be debited when the settlement instruction is affirmed. The Sender is required to generate a Zero Knowledge Proof with their ",(0,s.jsx)(t.a,{href:"/polymesh-documentation-site/polymesh-docs/polymesh-private/confidential-assets/#confidential-accounts",children:"Confidential Account"}),"'s private key and submit it to the chain to affirm an instruction leg. The Sender proof includes encrypted transaction details, ensuring the privacy of transaction amounts. The amount being transferred ",(0,s.jsx)(t.strong,{children:"must"})," be encrypted with the Receiver's and all required Auditors' Confidential Account public keys to be valid. A Sender must affirm a leg before a Receiver or Mediator can take further action."]}),"\n",(0,s.jsx)(t.h3,{id:"receiver",children:"Receiver"}),"\n",(0,s.jsx)(t.p,{children:"Each settlement instruction leg specifies a Receiver's Confidential Account. The Receiver decrypts the asset amount in the zero-knowledge proof to verify its validity. The Receiver affirms or rejects the legs of the settlement instruction where they are the Receiver, ensuring transaction integrity."}),"\n",(0,s.jsx)(t.h3,{id:"auditor",children:"Auditor"}),"\n",(0,s.jsx)(t.p,{children:"Auditors can optionally be specified by an Asset creator and/or the Venue Owner when creating an instruction. Auditors can decrypt the amount in the zero-knowledge proofs, allowing them to maintain a record of asset holders and meet regulatory reporting requirements. Affirmation proofs must include encrypted transaction details with all Auditor Elgamal public keys to allow them to decrypt the details."}),"\n",(0,s.jsx)(t.p,{children:"Auditor Elgamal keys are not required to be registered on-chain to a DID and do not perform any on-chain actions in the course of a settlement."}),"\n",(0,s.jsx)(t.h3,{id:"mediator",children:"Mediator"}),"\n",(0,s.jsx)(t.p,{children:"Mediators, if specified by the Asset Issuer or Venue Owner, are required to affirm legs of settlement instructions they are involved in before the instruction can be executed. In the course of affirming, Mediators may act as a Transfer Agent, ensuring the Sender and Receiver are eligible to transact before affirming to ensure compliance with regulatory requirements."}),"\n",(0,s.jsx)(t.p,{children:"It's important to note that a Mediator must also be specified as an Auditor to decrypt the amount being transferred in a leg."}),"\n",(0,s.jsx)(t.h2,{id:"affirmation",children:"Affirmation"}),"\n",(0,s.jsx)(t.p,{children:"Senders affirm instruction legs by submitting a valid zero-knowledge proof. Upon submitting, the sender's confidential account balance is reduced by the amount encrypted in the sender's proof."}),"\n",(0,s.jsx)(t.p,{children:"Receivers and Mediators affirm a leg they are a party to by simply submitting an affirmation transaction specifying the leg(s) they are affirming."}),"\n",(0,s.jsx)(t.h2,{id:"rejection",children:"Rejection"}),"\n",(0,s.jsx)(t.p,{children:"At any point prior to instruction execution, a Sender, Receiver, or Mediator may reject a settlement instruction. A single rejection rejects the entire instruction. Any encrypted amounts debited from sender accounts become available to them in their incoming encrypted balance."}),"\n",(0,s.jsx)(t.h2,{id:"instruction-execution",children:"Instruction Execution"}),"\n",(0,s.jsx)(t.p,{children:"After receiving all affirmations, any party involved in the instruction (Sender, Receiver, Mediator, or Venue Owner) can execute the settlement instruction. Executing the instruction updates the incoming encrypted balances for all receivers atomically. Assets received are added to a user's pending incoming balance and are not immediately added to their current account. The receiver controls when they want to apply the incoming balance."}),"\n",(0,s.jsx)(t.h2,{id:"frozen-assets-and-confidential-account",children:"Frozen Assets and Confidential Account"}),"\n",(0,s.jsx)(t.p,{children:"Assets can be frozen by the Asset Issuer, as can investor balances in a Confidential Account associated with that asset. This prevents assets from being added to new settlement instructions. When a freeze is applied, assets already committed to current settlement instructions are not frozen, nor is applying pending incoming balances for that asset."}),"\n",(0,s.jsx)(t.h2,{id:"settlement-flowchart",children:"Settlement Flowchart"}),"\n",(0,s.jsx)(t.p,{children:"Below is a flowchart illustrating the Confidential Asset Settlement process. The flowchart provides a visual representation of the steps involved, from the creation of a settlement instruction to its execution. Each step in the flowchart corresponds to a specific action or decision point in the settlement process described above."}),"\n",(0,s.jsx)(t.mermaid,{value:'flowchart TB\n\nA1([Venue Owner Creates Settlement Instruction])\nA2["Sender Generates Zk Proof\nand Affirms the Instruction.\n(Senders encrypted balance reduced)"]\nA3[/Await Affirmations/]\nA4{Receiver\nreviews ZkProof}\nA5[Receiver Affirms]\nA6[Reject instruction]\nA7{"Mediator\n(if applicable)\nreviews ZkProof"}\nA8["Mediator Affirms"]\nA9[Sender, Receiver, Mediator or Venue<br>Owner executes the instruction]\nA10(["Receiver Applies the incoming balance.\n(Receivers encrypted balance increased)"])\nA11(["Sender Applies the incoming balance refunds.\n(Senders encrypted balance increased)"])\nA12{All affirmations\nreceived?}\n\n\nA1 --\x3e A2 --\x3e A3\n\nA3 --\x3e A4\nA4 -- Accepts --\x3e A5\nA4 -- Rejects --\x3e A6\n\nA3 --\x3e A7\nA7 -- Accepts --\x3e A8\nA7 -- Rejects --\x3e A6\n\nA5 --\x3e A12\nA6 --\x3e A11\nA8 --\x3e A12\nA12 -- Yes --\x3e A9 --\x3e A10\nA12 -- No --\x3e A3\n'})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var i=n(96540);const s={},r=i.createContext(s);function a(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);
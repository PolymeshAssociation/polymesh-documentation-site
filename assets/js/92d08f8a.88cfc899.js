"use strict";(globalThis.webpackChunkpolymesh_developer_documentation=globalThis.webpackChunkpolymesh_developer_documentation||[]).push([[6221],{28453(e,n,t){t.d(n,{R:()=>a,x:()=>o});var i=t(96540);const r={},s=i.createContext(r);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(s.Provider,{value:n},e.children)}},62168(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"core-concepts/confidential-assets/confidential-assets-settlement-workflow","title":"Settlement Workflow","description":"Settlement lifecycle and transaction workflows for confidential assets","source":"@site/docs/200-core-concepts/090-confidential-assets/040-settlement-workflows.mdx","sourceDirName":"200-core-concepts/090-confidential-assets","slug":"/confidential-assets/settlement-workflow","permalink":"/polymesh-documentation-site/confidential-assets/settlement-workflow","draft":false,"unlisted":false,"editUrl":"https://github.com/PolymeshAssociation/polymesh-documentation-site/edit/develop/docs/200-core-concepts/090-confidential-assets/040-settlement-workflows.mdx","tags":[],"version":"current","sidebarPosition":40,"frontMatter":{"title":"Settlement Workflow","description":"Settlement lifecycle and transaction workflows for confidential assets","sidebar_label":"Settlement Workflow","slug":"/confidential-assets/settlement-workflow","id":"confidential-assets-settlement-workflow"},"sidebar":"docs","previous":{"title":"Asset Operations","permalink":"/polymesh-documentation-site/confidential-assets/asset-operations"},"next":{"title":"Compliance & Regulation","permalink":"/polymesh-documentation-site/confidential-assets/compliance-and-regulation"}}');var r=t(74848),s=t(28453);const a={title:"Settlement Workflow",description:"Settlement lifecycle and transaction workflows for confidential assets",sidebar_label:"Settlement Workflow",slug:"/confidential-assets/settlement-workflow",id:"confidential-assets-settlement-workflow"},o="Confidential Assets: Settlement Workflow",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Roles in a Settlement",id:"roles-in-a-settlement",level:2},{value:"Settlement Lifecycle",id:"settlement-lifecycle",level:2},{value:"Lifecycle (detailed)",id:"lifecycle-detailed",level:3},{value:"Core flow diagram",id:"core-flow-diagram",level:3},{value:"Creating a Settlement",id:"creating-a-settlement",level:2},{value:"Find and decrypt a settlement",id:"find-and-decrypt-a-settlement",level:2},{value:"Verifiability and Privacy (Decrypting Leg Data)",id:"verifiability-and-privacy-decrypting-leg-data",level:3},{value:"Sender affirmation",id:"sender-affirmation",level:2},{value:"Receiver affirmation",id:"receiver-affirmation",level:2},{value:"Mediator affirmation or rejection",id:"mediator-affirmation-or-rejection",level:2},{value:"Receiver claim",id:"receiver-claim",level:2},{value:"Sender counter update",id:"sender-counter-update",level:2},{value:"Sender revert",id:"sender-revert",level:2},{value:"Counter mechanics (PoB relevance)",id:"counter-mechanics-pob-relevance",level:2},{value:"Counter System Summary (Impact by Role)",id:"counter-system-summary-impact-by-role",level:3},{value:"Reversion and counter update",id:"reversion-and-counter-update",level:2},{value:"Querying On-Chain Settlement Information",id:"querying-on-chain-settlement-information",level:2},{value:"Batchability and Multi-Party Transactions (MPT)",id:"batchability-and-multi-party-transactions-mpt",level:2},{value:"Supported batching patterns",id:"supported-batching-patterns",level:3},{value:"Important properties",id:"important-properties",level:3},{value:"Operational considerations for batching",id:"operational-considerations-for-batching",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components},{ZoomableMermaid:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ZoomableMermaid",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"confidential-assets-settlement-workflow",children:"Confidential Assets: Settlement Workflow"})}),"\n",(0,r.jsxs)(n.p,{children:["This page describes the lifecycle and mechanics of confidential settlements (transfers) on Polymesh. For related setup and asset flows, see ",(0,r.jsx)(n.a,{href:"/confidential-assets/onboarding-accounts",children:"Onboarding & Accounts"})," and ",(0,r.jsx)(n.a,{href:"/confidential-assets/asset-operations",children:"Asset Operations"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"Confidential settlement is intentionally multi-phase to align with regulated-market requirements and architectural constraints:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Creation (publish)"}),": Encrypted legs and a settlement proof are recorded; no balances change."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Affirmations (consent)"}),": Sender/receiver (and mediator, if required) explicitly affirm or reject."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Claim (credit)"}),": Receiver claims to credit value into finalized balance; counters update accordingly."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Why this design?"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Receiver affirmation"}),": Mirrors institutional securities workflows where receivers must accept obligations before credit."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Non-interactivity"}),": Parties act asynchronously; senders can initiate while receivers are offline."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Concurrency handling"}),": Pending counters prevent state conflicts and make Proof of Balance workable."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compliance gating"}),": Mediators provide prospective control when asset policy requires it."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"roles-in-a-settlement",children:"Roles in a Settlement"}),"\n",(0,r.jsx)(n.p,{children:"Confidential settlements involve clearly defined roles:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sender:"})," Affirms the leg that transfers value. When affirmed, their spendable balance is debited and the pending counter increases."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Receiver:"})," Explicitly affirms acceptance of value; later claims to credit the incoming amount into the finalized balance."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mediator (optional):"})," Active compliance participant who must affirm or reject when required by asset policy; gates execution."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Auditor (optional):"})," Passive compliance participant who can decrypt asset-specific leg details for retrospective verification; does not gate execution."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This dual model (mediators vs. auditors) provides prospective control and retrospective visibility without sacrificing on-chain confidentiality."}),"\n",(0,r.jsx)(n.h2,{id:"settlement-lifecycle",children:"Settlement Lifecycle"}),"\n",(0,r.jsx)(n.p,{children:"At a high level, a confidential transfer/settlement has three phases:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Creation"}),": publish the encrypted legs and a settlement proof."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Affirmations"}),": sender/receiver (and optionally mediator) record their decision."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Claim/finalization"}),": the receiver claims and credits the value."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Why split it this way?"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Receiver affirmation is a real-world requirement for institutional securities-style transfers."}),"\n",(0,r.jsx)(n.li,{children:"The protocol must support asynchronous parties (senders and receivers do not need to be online at the same time)."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"lifecycle-detailed",children:"Lifecycle (detailed)"}),"\n",(0,r.jsx)(t,{children:(0,r.jsx)(n.mermaid,{value:"flowchart TD\n    A[Create Settlement] --\x3e B[Status: Pending]\n    B --\x3e C{Affirmations}\n    C --\x3e|Sender Affirms| D[Balance Deducted<br>Counter +1]\n    C --\x3e|Receiver Affirms| E[Counter +1]\n    C --\x3e|Mediator Affirms| F[Mediator OK]\n\n    D & E & F --\x3e G{All Required Affirmed?}\n    G --\x3e|No| C\n    G --\x3e|Yes| H[Settlement Executes]\n\n    H --\x3e I[Receiver Claims Assets<br>Counter -1]\n    H --\x3e J[Sender Updates Counter<br>Counter -1]\n\n    I & J --\x3e K[Finalized]\n\n    C --\x3e|Someone Rejects| L[Settlement Rejected]\n    L --\x3e M{Sender Affirmed?}\n    M --\x3e|No| K\n    M --\x3e|Yes| N[Sender Reverts<br>Balance Restored<br>Counter -1]\n    N --\x3e K"})}),"\n",(0,r.jsx)(n.h3,{id:"core-flow-diagram",children:"Core flow diagram"}),"\n",(0,r.jsx)(t,{children:(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant C as Settlement Creator\n  participant CH as Polymesh Chain\n  participant S as Sender\n  participant R as Receiver\n  participant M as Mediator\n  participant PS as Proof Service\n\n  Note over C,CH: Create settlement (publish only)\n  C->>CH: Query asset registry (auditor/mediator keys)\n  C->>CH: Query asset curve-tree root\n  C->>PS: Build legs + SettlementProof(root, registry)\n  PS--\x3e>C: SettlementProof bytes\n  C->>CH: createSettlement(proof)\n  CH->>CH: Record pending settlement\n  CH--\x3e>C: Emit SettlementCreated event with id\n\n  Note over S,CH: Sender discovery + affirmation\n  S->>CH: Fetch settlement metadata(id) + encrypted leg\n  S->>S: Try decrypt with encryption key\n  S->>CH: Query account curve-tree root + leaf path\n  S->>PS: SenderAffirmationProof(oldState, leafPath, leg)\n  PS--\x3e>S: SenderAffirmationProof\n  S->>CH: senderAffirmation(proof)\n  CH->>CH: Debit finalized\n  CH->>CH: Counter +1\n  CH->>CH: Update accumulator\n\n  Note over M,CH: Mediator action (if required)\n  M->>CH: Fetch encrypted leg\n  M->>M: Try decrypt with encryption key\n  M->>PS: MediatorProof(accept|reject)\n  PS--\x3e>M: MediatorAffirmationProof\n  M->>CH: mediatorAffirmation(proof)\n\n  Note over R,CH: Receiver discovery + affirmation\n  R->>CH: Fetch encrypted leg\n  R->>R: Try decrypt with encryption key\n  R->>CH: Query account curve-tree root + leaf path\n  R->>PS: ReceiverAffirmationProof(oldState, leafPath, leg)\n  PS--\x3e>R: ReceiverAffirmationProof\n  R->>CH: receiverAffirmation(proof)\n\n  CH--\x3e>CH: Execute when all required parties affirmed\n\n  Note over R,CH: Receiver claim (credit)\n  R->>CH: Query updated root + leaf path\n  R->>PS: ReceiverClaimProof(leafPath, leg)\n  PS--\x3e>R: ReceiverClaimProof\n  R->>CH: receiverClaim(proof)\n  CH->>CH: Credit finalized\n  CH->>CH: Counter -1\n  CH->>CH: Update accumulator\n\n  Note over S,CH: Sender counter update (PoB helper)\n  S->>CH: Query updated root + leaf path\n  S->>PS: CounterUpdateProof(leafPath)\n  PS--\x3e>S: CounterUpdateProof\n  S->>CH: senderUpdateCounter(proof)\n  CH->>CH: Counter -1\n  CH->>CH: Update accumulator\n\n  alt Mediator rejects\n    Note over S,CH: Sender revert (restore)\n    S->>CH: Query updated root + leaf path\n    S->>PS: RevertProof(leafPath, leg)\n    PS--\x3e>S: RevertProof\n    S->>CH: senderRevert(proof)\n    CH->>CH: Restore balance\n    CH->>CH: Counter -1\n    CH->>CH: Update accumulator\n  end"})}),"\n",(0,r.jsx)(n.h2,{id:"creating-a-settlement",children:"Creating a Settlement"}),"\n",(0,r.jsx)(n.p,{children:"A settlement is created by defining the transaction legs (sender, receiver, asset type, and value) and generating proofs that ensure both cryptographic validity and regulatory compliance. The creator (who may be a separate entity from the sender or receiver) publishes:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Encrypted leg data"})," \u2014 Encrypted for multiple parties: the sender, receiver, and any designated auditors/mediators retrieved from the on-chain regulatory list. This enables selective visibility for compliance oversight without revealing details to the public."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Zero-Knowledge Settlement Proof"})," \u2014 A non-interactive zero-knowledge proof (NIZK) demonstrating:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Ciphertext well-formedness:"})," All encrypted values (identities, amounts, asset types) are correctly constructed."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Regulatory consistency:"})," The asset type and its compliance rules match the on-chain regulatory registry."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Value integrity:"})," The transfer amount is positive and within system bounds."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The proof also uses accumulator membership to hide which specific asset type is being transferred, maintaining unlinkability while still verifying regulatory compliance."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Chain Recording:"}),' Upon validation, the chain assigns a unique settlement identifier and records it in a pending state. Importantly, no balances are deducted yet\u2014the sender\'s funds remain spendable until they explicitly affirm the settlement. The settlement remains "in transit" awaiting affirmations from required parties (sender, receiver, and mediator if applicable), enabling asynchronous participation where parties need not be online simultaneously.']}),"\n",(0,r.jsx)(n.h2,{id:"find-and-decrypt-a-settlement",children:"Find and decrypt a settlement"}),"\n",(0,r.jsx)(n.p,{children:"All parties to a settlement (sender, receiver, mediator, auditor) must first discover the settlement and decrypt the relevant leg details to verify their involvement and inspect the transaction terms before taking action."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Discovery and decryption process:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Fetch settlement by ID from chain (received from another party or discovered via on-chain scan), pull encrypted legs."}),"\n",(0,r.jsx)(n.li,{children:"Attempt decryption with your account or encryption keys (sender/receiver/mediator/auditor)."}),"\n",(0,r.jsx)(n.li,{children:"If decryption succeeds, you are a party to this settlement; save the settlement ID or decrypted leg details locally for verification and proof generation."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Verify the details:"})," Inspect the sender, receiver, asset type, amount, and any regulatory conditions before deciding to affirm or reject."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"verifiability-and-privacy-decrypting-leg-data",children:"Verifiability and Privacy (Decrypting Leg Data)"}),"\n",(0,r.jsx)(n.p,{children:"Leg payloads are encrypted so only designated parties can read them (sender, receiver, and asset-specific mediator and auditor keys). A public registry maps assets to their mediator and auditor keys, enabling:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Scoped visibility:"})," Authorized parties can decrypt and inspect the leg details for assets they oversee."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Public confidentiality:"})," Observers cannot read private values; they only see commitments, nullifiers, and proof validity."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This design preserves privacy on the public ledger while supporting per-asset auditability and optional prospective control via mediation."}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"Account balances are not included in leg ciphertexts. Balances are represented as commitments and validated via zero-knowledge proofs, so even authorized decryption of a leg does not reveal a participant's overall balance."})}),"\n",(0,r.jsx)(n.h2,{id:"sender-affirmation",children:"Sender affirmation"}),"\n",(0,r.jsxs)(n.p,{children:["After discovering and decrypting the settlement (see ",(0,r.jsx)(n.a,{href:"#find-and-decrypt-a-settlement",children:"Find and decrypt a settlement"}),"), the sender verifies the leg details and submits an affirmation proof to commit their assets to the transfer."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Effect on balance and counter:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The sender's ",(0,r.jsx)(n.strong,{children:"spendable balance is immediately reduced"})," by the transfer amount."]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.strong,{children:"pending counter increases by 1"}),", placing the debited amount in a pending state."]}),"\n",(0,r.jsx)(n.li,{children:"This prevents double-spending: the same assets cannot be committed to multiple settlements until the original settlement is finalized or reverted."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Process:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Preconditions: account registered on-chain; access to account keys; locally cached account-asset state."}),"\n",(0,r.jsx)(n.li,{children:"Build account leaf path (root + curve tree path) and prepare the decrypted leg."}),"\n",(0,r.jsxs)(n.li,{children:["Proof service produces a ",(0,r.jsx)(n.strong,{children:"sender affirmation proof"})," that: (a) spends the old state, (b) debits amount, (c) emits a nullifier, (d) increments counter."]}),"\n",(0,r.jsxs)(n.li,{children:["Submit the ",(0,r.jsx)(n.code,{children:"senderAffirmation"})," transaction to persist the updated state (new commitment/index)."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"In the underlying construction, the sender proves membership of their old committed state in the accumulator, reveals a nullifier for the old state, and posts a new commitment reflecting the update."}),"\n",(0,r.jsx)(n.h2,{id:"receiver-affirmation",children:"Receiver affirmation"}),"\n",(0,r.jsxs)(n.p,{children:["After discovering and decrypting the settlement (see ",(0,r.jsx)(n.a,{href:"#find-and-decrypt-a-settlement",children:"Find and decrypt a settlement"}),"), the receiver verifies the leg details and decides whether to affirm (accept) or reject the incoming transfer."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Process:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Preconditions: account registered on-chain; access to account keys; locally cached account-asset state, leaf path, decrypted leg."}),"\n",(0,r.jsxs)(n.li,{children:["Proof service produces a ",(0,r.jsx)(n.strong,{children:"receiver affirmation proof"})," that increments the pending counter (no balance change)."]}),"\n",(0,r.jsxs)(n.li,{children:["Submit the ",(0,r.jsx)(n.code,{children:"receiverAffirmation"})," transaction to store the updated state."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The affirmation step records consent and increments the counter, enabling the receiver to claim the value after settlement execution."}),"\n",(0,r.jsx)(n.h2,{id:"mediator-affirmation-or-rejection",children:"Mediator affirmation or rejection"}),"\n",(0,r.jsxs)(n.p,{children:["After discovering and decrypting the settlement (see ",(0,r.jsx)(n.a,{href:"#find-and-decrypt-a-settlement",children:"Find and decrypt a settlement"}),"), the mediator inspects the leg details and decides whether to affirm (permit) or reject the settlement based on regulatory policy."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Uses only encryption keys (no account balance state)."}),"\n",(0,r.jsxs)(n.li,{children:["Proof service produces a ",(0,r.jsx)(n.strong,{children:"mediator affirmation proof"})," with ",(0,r.jsx)(n.code,{children:"accept=true"})," (approve) or ",(0,r.jsx)(n.code,{children:"accept=false"})," (reject)."]}),"\n",(0,r.jsxs)(n.li,{children:["Submit ",(0,r.jsx)(n.code,{children:"mediatorAffirmation"}),"; rejection halts the settlement until the sender reverts."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Until mediation is complete, the settlement remains pending."}),"\n",(0,r.jsx)(n.h2,{id:"receiver-claim",children:"Receiver claim"}),"\n",(0,r.jsxs)(n.p,{children:["After the settlement has been executed (all required parties have affirmed), the receiver submits a ",(0,r.jsx)(n.strong,{children:"claim"})," proof that credits the incoming value into their finalized balance and reduces the pending counter."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Inputs: updated leaf path, decrypted leg, account state."}),"\n",(0,r.jsxs)(n.li,{children:["Proof service generates the ",(0,r.jsx)(n.strong,{children:"claim proof"})," to credit the incoming amount and decrement the counter."]}),"\n",(0,r.jsxs)(n.li,{children:["Submit ",(0,r.jsx)(n.code,{children:"receiverClaim"}),"; persist new state."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:'This separation is important: it allows regulated "accept/reject first, credit later" semantics.'}),"\n",(0,r.jsx)(n.h2,{id:"sender-counter-update",children:"Sender counter update"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["After execution, sender can generate a ",(0,r.jsx)(n.strong,{children:"counter update proof"})," to decrement the counter (no balance change) and make future PoB proofs cheaper."]}),"\n",(0,r.jsxs)(n.li,{children:["Submit ",(0,r.jsx)(n.code,{children:"senderUpdateCounter"}),"; persist new state."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"sender-revert",children:"Sender revert"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If a mediator rejects, a sender who already affirmed can generate a ",(0,r.jsx)(n.strong,{children:"revert proof"})," to restore the debited amount and decrement the counter."]}),"\n",(0,r.jsxs)(n.li,{children:["Submit ",(0,r.jsx)(n.code,{children:"senderRevert"}),"; persist new state."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"counter-mechanics-pob-relevance",children:"Counter mechanics (PoB relevance)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Affirmations add to the pending counter; claims/reverts/counter-updates subtract from it."}),"\n",(0,r.jsx)(n.li,{children:"Lower counters shrink the footprint of later Proof of Balance proofs by reducing pending legs that must be referenced."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"counter-system-summary-impact-by-role",children:"Counter System Summary (Impact by Role)"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Role"}),(0,r.jsx)(n.th,{children:"Action"}),(0,r.jsx)(n.th,{children:"Impact on Balance"}),(0,r.jsx)(n.th,{children:"Impact on Counter"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Sender"})}),(0,r.jsx)(n.td,{children:"Affirm"}),(0,r.jsx)(n.td,{children:"\u2212Amount"}),(0,r.jsx)(n.td,{children:"+1"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Sender"})}),(0,r.jsx)(n.td,{children:"Revert (after affirming)"}),(0,r.jsx)(n.td,{children:"+Amount"}),(0,r.jsx)(n.td,{children:"\u22121"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Sender"})}),(0,r.jsx)(n.td,{children:"Update Counter (after execute)"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"\u22121"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Receiver"})}),(0,r.jsx)(n.td,{children:"Affirm"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"+1"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Receiver"})}),(0,r.jsx)(n.td,{children:"Claim Assets (after execute)"}),(0,r.jsx)(n.td,{children:"+Amount"}),(0,r.jsx)(n.td,{children:"\u22121"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Mediator"})}),(0,r.jsx)(n.td,{children:"Affirm or Reject"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"\u2014"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"Counters make PoB proofs accountable to pending obligations while keeping transaction history private."}),"\n",(0,r.jsx)(n.h2,{id:"reversion-and-counter-update",children:"Reversion and counter update"}),"\n",(0,r.jsxs)(n.p,{children:["These operations maintain flexibility and efficiency: reversion lets senders reclaim funds from rejected settlements (see ",(0,r.jsx)(n.a,{href:"#sender-revert",children:"Sender revert"}),"), while counter updates reduce PoB proof size by batch-finalizing completed legs (see ",(0,r.jsx)(n.a,{href:"#sender-counter-update",children:"Sender counter update"}),")."]}),"\n",(0,r.jsx)(n.h2,{id:"querying-on-chain-settlement-information",children:"Querying On-Chain Settlement Information"}),"\n",(0,r.jsx)(n.p,{children:"Applications and authorized participants can inspect settlement state via chain queries. Typical queries include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Settlement state:"})," Returns the current status (e.g., pending, executed, finalized) for a given settlement reference."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Encrypted legs:"})," Returns the encrypted leg payloads by index; only authorized keys can decrypt."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Memo:"})," Returns any optional memo attached to the settlement."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pending affirmations:"})," Returns how many affirmations are still required before execution."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pending finalizations:"})," Returns how many post-execution steps (claims or counter updates) remain before finalization."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"These queries enable UIs and services to track lifecycle progression without revealing confidential values."}),"\n",(0,r.jsx)(n.h2,{id:"batchability-and-multi-party-transactions-mpt",children:"Batchability and Multi-Party Transactions (MPT)"}),"\n",(0,r.jsx)(n.p,{children:"Polymesh Confidential Assets (PCA) support batching multiple proof operations into a single transaction for efficiency. Most operations require an accumulator membership proof (the heaviest part of ZKP computation), so combining related actions reduces transaction count and proving work while preserving confidentiality."}),"\n",(0,r.jsx)(n.h3,{id:"supported-batching-patterns",children:"Supported batching patterns"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Multi-party transfers (one sender \u2192 many receivers):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A sender publishes multiple encrypted legs to different receivers in one account state transition."}),"\n",(0,r.jsx)(n.li,{children:"The sender's proof shows the total debit equals the sum of all leg values, requiring just one accumulator membership proof."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Multi-party affirmations (one receiver \u2190 many senders):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A receiver scans for pending legs addressed to them and affirms several in one transaction."}),"\n",(0,r.jsx)(n.li,{children:"The proof demonstrates they can decrypt each selected leg and that the credited amount equals the sum of affirmed values."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Aggregatable reversions (sender reclaim):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A sender reclaims funds from multiple un-affirmed legs in a single submission."}),"\n",(0,r.jsx)(n.li,{children:"The proof shows the sender authored the referenced legs and updates their balance by the aggregate reversed amount in one state transition."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Efficient account maintenance (PoB helpers):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Counter updates (CU):"})," Batch pointers to finalized legs to reduce the pending counter in one step."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pending-balance updates (PBU):"})," Batch updates to reduce hidden pending balance records in one step."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Atomic instant settlements:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Parties can combine ",(0,r.jsx)(n.code,{children:"ExecuteInstantSettlement"})," with ",(0,r.jsx)(n.code,{children:"InstantSenderAffirmation"})," and ",(0,r.jsx)(n.code,{children:"InstantReceiverAffirmation"})," into a single atomic batch."]}),"\n",(0,r.jsx)(n.li,{children:"This creates and fully affirms a settlement in one transaction, assuming off-chain coordination of commitments."}),"\n",(0,r.jsx)(n.li,{children:"Unlike the normal multi-phase flow, instant settlements update balances for both parties without changing counters (sender balance decreases, receiver balance increases, both counters remain unchanged as the complete settlement executes in a single transaction)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Mixed operational batching:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A single submission can include different proof types, for example: a receiver claim for an older leg, a new sender affirmation, and a sender counter update\u2014all verified together."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"important-properties",children:"Important properties"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Independent leg tracking:"})," Each leg's per-party affirmation status (sender affirmed, receiver affirmed, mediator decision, etc.) is tracked independently on-chain. This granular tracking allows the system to record which parties have acted on each leg. However, if any leg in a settlement is rejected (e.g., by a mediator), the entire settlement is rejected. Whether remaining legs can be reversed or claimed depends on the settlement's overall status."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Per-party decryption responsibilities:"})," Batching does not compromise participant privacy. Each receiver must still independently discover and decrypt only the legs intended for them using their unique encryption key; unauthorized parties cannot see other participants' leg details even within a batch."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Amortized proving efficiency:"})," Batching multiple actions\u2014such as instant settlements or multi-receiver transfers\u2014into a single transaction reduces the cost per action. The most computationally expensive part is the accumulator membership proof; batching allows multiple actions to share a single membership proof and state transition, reducing total on-chain submissions and verification overhead compared to separate transactions."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"operational-considerations-for-batching",children:"Operational considerations for batching"}),"\n",(0,r.jsx)(n.p,{children:"Batching improves efficiency but introduces practical nuances you should account for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Concurrency safety:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Only the account owner can submit transactions that update their account state. This design prevents a scenario where another user's settlement execution invalidates your pending proof (e.g., your receiver affirmation proof becomes invalid because a third party's settlement changed the chain state you built your proof against)."}),"\n",(0,r.jsx)(n.li,{children:"The chain stores a window of recent accumulator roots so a proof against a slightly older root remains valid during broadcast, improving reliability with relayers and enabling asynchronous multi-party affirmations."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Linkability trade-off in maintenance:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Batching multiple finalized references into one update creates ephemeral linkability between the referenced items (observers can tell those references were processed together in one account update, but amounts and identities remain hidden)."}),"\n",(0,r.jsx)(n.li,{children:"If maximum privacy is required, perform updates sequentially; if cost and simplicity are the priority, batch them."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fee proof priority (relayer flow):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The fee proof is verified first. If it fails, the transaction is rejected immediately, preventing unfunded, complex batches from consuming resources."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Integrity of batched legs:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Sender-side MPT proofs must still ensure value conservation (total debit equals sum of leg values) and correct construction of ciphertexts."}),"\n",(0,r.jsx)(n.li,{children:"Receiver-side affirmation proofs must still prove decryptability and correct crediting, regardless of batching."}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);